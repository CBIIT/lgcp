BiocManager::install(c("DropletUtils"))
library(DropletUtils)
sce <- read10xCounts("/Volumes/Group05/CCBB/SA/Bioinfo_2018/CS024650_Kelly_Agarwal/02_PrimaryAnalysisOutput/00_FullCellrangerOutput/SCAF604_683/")
sce <- read10xCounts("/Volumes/Group05/CCBB/SA/Bioinfo_2018/CS024650_Kelly_Agarwal/02_PrimaryAnalysisOutput/00_FullCellrangerOutput/SCAF604_683/outs/")
sce <- read10xCounts("/Volumes/Group05/CCBB/SA/Bioinfo_2018/CS024650_Kelly_Agarwal/02_PrimaryAnalysisOutput/00_FullCellrangerOutput/SCAF604_683/outs/filtered_feature_bc_matrix/")
sce
library(edgeR)
edgeR::glmQLFTest()
?edgeR::glmQLFTest
?limma::voom
BiocManager::install("scater")
library(scater)
sce <- calculateQCMetrics(sce)
sce
rowData(sce)$Symbol
ctrl <- list(Mito = grep("^MT|^Mt", rowData(sce)$Symbol))
ctrl
rowData(sce)$Symbol[ctrl$Mito]
ctrl <- list(Mito = grep("^MT|^Mt-", rowData(sce)$Symbol))
rowData(sce)$Symbol[ctrl$Mito]
ctrl <- list(Mito = grep("^MT|^Mrp", rowData(sce)$Symbol))
rowData(sce)$Symbol[ctrl$Mito]
ctrl <- list(Mito = grep("^MT|^mt-", rowData(sce)$Symbol))
rowData(sce)$Symbol[ctrl$Mito]
sce <- calculateQCMetrics(sce,
feature_controls = ctrl,
compact = TRUE,
BPPARAM = MulticoreParam(7))
high_mito <- isOutlier(colData(sce)$scater_qc$feature_control_Mito$pct_counts,
nmads = 3, type = "higher")
metadata(sce)$high_mito <- high_mito
metadata(sce)
table(metadata(sce))
table(metadata(sce)$high_mito)
sce <- sce[, !metadata(sce)$high_mito]
num_reads <- 1
num_cells <- 0.05 * ncol(sce)
keep <- which(DelayedArray::rowSums(counts(sce) >= num_reads) >= num_cells)
metadata(sce)$genes_keep <- keep
low_lib_sce <- isOutlier(sce$log10_total_counts, type="lower", nmad=3)
low_genes_sce <- isOutlier(sce$log10_total_features_by_counts, type="lower", nmad=3)
sce <- sce[, !(low_lib_sce | low_genes_sce)]
sce
library(DropletUtils)
library(scater)
library(mbkmeans)
BiocManager::install(c("mbkmeans", "scran"))
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
sce <- read10xCounts("/Volumes/Group05/CCBB/SA/Bioinfo_2018/CS024650_Kelly_Agarwal/02_PrimaryAnalysisOutput/00_FullCellrangerOutput/SCAF604_683/outs/filtered_feature_bc_matrix/")
ctrl <- list(Mito = grep("^MT|^mt-", rowData(sce)$Symbol))
sce <- scater::calculateQCMetrics(sce,
feature_controls = ctrl,
compact = TRUE,
BPPARAM = MulticoreParam(7))
install.packages("uwot")
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
library(TxDb.Mmusculus.UCSC.mm10.ensGene)
library(BiocSingular)
library(annotables)
libary(devtools)
library(devtools)
install.packages("devtools")
library(devtools)
devtools::install_github("stephenturner/annotables")
library(annotables)
library(tidyverse)
sce <- read10xCounts("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/02_PrimaryAnalysisOutput/00_FullCellrangerOutputs/SCAF730_190328_G7/outs/filtered_feature_bc_matrix/")
# ADD FEATURE FOR REF ORG HERE!
location_tidy <- rowData(sce) %>%
as.data.frame() %>%
left_join(grch38 %>%
select(ensgene, chr), by = c("ID" = "ensgene")) %>%
distinct()
is.mito <- which(location_tidy$chr == "MT")
sce <- calculateQCMetrics(sce, feature_controls=list(Mito=is.mito), BPPARAM = MulticoreParam(7))
# remove cells with log-library sizes that are more than 3 MADs below the median
qc.lib <- isOutlier(log(sce$total_counts), nmads=3, type="lower")
# remove cells where the log-transformed number of expressed genes is 3 MADs below the median
qc.nexprs <- isOutlier(log(sce$total_features_by_counts), nmads=3,
type="lower")
# remove cells where the number of mito genes is 3 MADs above the median
qc.mito <- isOutlier(sce$pct_counts_Mito, nmads=3, type="higher")
discard <- qc.lib | qc.nexprs | qc.mito
# Summarize the number of cells removed for each reason.
DataFrame(LibSize=sum(qc.lib),
NExprs=sum(qc.nexprs),
MitoProp=sum(qc.mito),
Total=sum(discard))
# Retain only high-quality cells in the SingleCellExperiment.
sce <- sce[,!discard]
## normalization
sce <- normalize(sce)
## feature selection
fit <- trendVar(sce, use.spikes = FALSE)
dec <- decomposeVar(sce, fit)
hvg <- rownames(dec[dec$bio > 0, ]) # ~4k genes
## dimensionality reduction
set.seed(1234)
sce <- runPCA(sce,
feature_set = hvg)
sce <- runUMAP(sce)
plotReducedDim(sce, use_dimred = "UMAP")
BiocManager::install("sc3")
BiocManager::install("SC3")
library(SC3)
head(rowData(sce))
rowData(sce)$feature_symbol <- rowData(sce)$Symbol
class(counts(sce))
counts(sce) <- as.matrix(counts(sce))
sce <- sc3(sce,
ks = 3:6,
k_estimator = TRUE,
n_cores = 7)
is.matrix(counts(sce))
counts(sce)
sce <- sc3(sce,
ks = 3:6,
k_estimator = TRUE)
?sc3
sce <- sc3(sce,
ks = 3:6,
k_estimator = TRUE,
n_cores = 1)
traceback()
logcounts(sce)
logcounts(sce) <- as.matrix(logcounts(sce))
sce <- sc3(sce,
ks = 3:6,
k_estimator = TRUE)
rowData(sce)
head(colData(sce))
sc3_cols <- paste0('sc3_', 3:6, '_clusters')
p_l <- map(sc3_cols, ~ plotUMAP(sce, colour_by = .))
wrap_plots(p_l, ncol = 2)
install.packages("pathwork")
install.packages("patchwork")
plot(p_l[[1]])
plot(p_l[[2]])
plot(p_l[[3]])
plot(p_l[[4]])
plot(p_l[[5]])
plot(p_l[[1]])
plot(p_l[[4]])
str(metadata(sce)$sc3, 1)
metadata(sce)$sc3$k_estimation
save.image("/Volumes/Group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
library(BiocSingular)
library(annotables)
library(tidyverse)
library(SC3)
plot(test_glmpca_poi_30$factors[,1:5])
plot(test_glmpca_poi_100$factors[,1:5])
plot(test_glmpca_poi_30$factors[,1:2])
plot(test_glmpca_poi_30$factors[,1:3])
plot(test_glmpca_poi_30$factors[,1,3])
plot(test_glmpca_poi_30$factors[,c(1,3)])
plot(test_glmpca_poi_30$factors[,c(1,2)])
plot(test_glmpca_poi_30$factors[,c(2,3)])
?mbkmeans
mbkmeans(test_glmpca_poi_30$factors, clusters = 4)
mbkmeans(as.matrix(test_glmpca_poi_30$factors), clusters = 4)
test_glmpca_poi_30$coefX %>% head()
test_glmpca_poi_30$loadings %>% head()
?order
test_glmpca_poi_30$loadings %>%
lapply(order, decreasing = T)
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
BiocManager::install(c("flowCore", "DOSE"))
BiocManager::install(c("FlowSOM"))
BiocManager::install(c("FlowSOM"))
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
library(BiocSingular)
library(annotables)
library(tidyverse)
library(SC3)
library(msigdbr)
library(clusterProfiler)
BiocManager::install(c("clusterProfilier"))
BiocManager::install(c("clusterProfiler"))
install.packages("msigdbr")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
gsea_df <- loadings_gsea_symbols %>%
bind_rows(.id = "dim")
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
library(BiocSingular)
library(annotables)
library(tidyverse)
library(SC3)
library(msigdbr)
library(clusterProfiler)
library(flowCore)
library(FlowSOM)
library(factoextra)
library(NbClust)
gsea_df <- loadings_gsea_symbols %>%
bind_rows(.id = "dim")
View(gsea_df)
pca_loadings_gsea[[1]]@result
x <- pca_loadings_gsea[[1]]
x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez)
x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
group_by(ID) %>%
summarise(num_uniq = n_distinct(entrez))
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
group_by(ID) %>%
summarise(num_uniq = n(entrez))
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
group_by(ID, entrez) %>%
summarise(num_uniq = n())
head(new_result)
View(new_result)
table(new_result$num_uniq)
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
mutate(entrez = as.integer(entrez)) %>%
left_join(grch38 %>%
dplyr::select(entrez, symbol))
View(new_result)
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
mutate(entrez = as.integer(entrez)) %>%
left_join(grch38 %>%
dplyr::select(entrez, symbol))  %>%
dplyr::select(-c(core_enrichment, entrez))
View(new_result)
dim(new_result)
dim(distinct(new_result))
loadings_gsea_symbols <- lapply(pca_loadings_gsea, function(x){
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
mutate(entrez = as.integer(entrez)) %>%
left_join(grch38 %>%
dplyr::select(entrez, symbol)) %>%
dplyr::select(-c(core_enrichment, entrez)) %>%
dplyr::distinct() %>%
group_by_at(vars(-symbol)) %>%
summarize(core_enrichment = paste(symbol, collapse = ", "))
return(new_result)
})
gsea_df <- loadings_gsea_symbols %>%
bind_rows(.id = "dim")
View(gsea_df)
loadings_gsea_symbols <- lapply(pca_loadings_gsea, function(x){
new_result <- x@result %>%
mutate(entrez = str_split(core_enrichment, "/")) %>%
unnest(entrez) %>%
mutate(entrez = as.integer(entrez)) %>%
left_join(grch38 %>%
dplyr::select(entrez, symbol)) %>%
dplyr::select(-c(core_enrichment, entrez)) %>%
dplyr::distinct() %>%
group_by_at(vars(-symbol)) %>%
summarize(num_genes = n_distinct(symbol),
core_enrichment = paste(symbol, collapse = ", "))
return(new_result)
})
gsea_df <- loadings_gsea_symbols %>%
bind_rows(.id = "dim")
View(gsea_df)
gsea_df %>% dplyr::filter(qvalues <= 0.1) %>% group_by(dim) %>% count()
gsea_df %>% dplyr::filter(qvalues <= 0.1) %>% group_by(dim) %>% count() %>% View()
gsea_df %>% dplyr::filter(qvalues <= 0.05) %>% group_by(dim) %>% count() %>% View()
save.image("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
library(DropletUtils)
library(DropletUtils)
library(scater)
library(mbkmeans)
library(scran)
library(BiocSingular)
library(annotables)
library(tidyverse)
library(SC3)
library(msigdbr)
library(clusterProfiler)
library(flowCore)
library(FlowSOM)
source("single-cell/scrna2019/algs/glmpca.R")
source("single-cell/scrna2019/algs/glmpca.R")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
View(som_nodes_stats)
head(plot_df)
som_nodes_stats <- plot_df %>%
group_by(som_node, reduced_dim_id, cluster_median) %>%
summarise(som_mean = mean(value),
som_median = median(value)) %>%
left_join(plot_df %>%
group_by(som_node, reduced_dim_id, cluster_median) %>%
count(cluster_id) %>%
ungroup() %>%
spread(cluster_id,
n,
fill = 0) %>%
mutate(fraction_high = high/(low+high)))
som_nodes_stats <- plot_df %>%
group_by(som_node, reduced_dim_id) %>%
summarise(som_mean = mean(value),
som_median = median(value)) %>%
left_join(plot_df %>%
group_by(som_node, reduced_dim_id) %>%
count(cluster_id) %>%
ungroup() %>%
spread(cluster_id,
n,
fill = 0) %>%
mutate(fraction_high = high/(low+high)))
head(kmeans_dim_id)
head(som_nodes_stats)
kmeans_dim_id %>%
dplyr::select(reduced_dim_id, cluster_id, cluster_median)
kmeans_dim_id %>%
dplyr::select(reduced_dim_id, cluster_id, cluster_median) %>%
spread(cluster_id, cluster_median)
kmeans_dim_id %>%
dplyr::select(reduced_dim_id, cluster_id, cluster_median) %>%
spread(cluster_id, cluster_median) %>%
setNames(c("reduced_dim_id", "kmns_lo_clstr_med", "kmns_hi_clstr_med"))
som_nodes_stats <- plot_df %>%
group_by(som_node, reduced_dim_id) %>%
summarise(som_mean = mean(value),
som_median = median(value)) %>%
left_join(plot_df %>%
group_by(som_node, reduced_dim_id) %>%
count(cluster_id) %>%
ungroup() %>%
spread(cluster_id,
n,
fill = 0) %>%
mutate(fraction_high = high/(low+high))) %>%
left_join(kmeans_dim_id %>%
dplyr::select(reduced_dim_id, cluster_id, cluster_median) %>%
spread(cluster_id, cluster_median) %>%
setNames(c("reduced_dim_id", "kmns_lo_clstr_med", "kmns_hi_clstr_med")))
table(some_node_stats$som_node)
table(som_node_stats$som_node)
som_nodes_stats$som_node %>% table()
som_nodes_stats <- plot_df %>%
group_by(som_node, reduced_dim_id) %>%
summarise(som_mean = mean(value),
som_median = median(value)) %>%
left_join(plot_df %>%
group_by(som_node, reduced_dim_id) %>%
count(cluster_id) %>%
ungroup() %>%
spread(cluster_id,
n,
fill = 0) %>%
mutate(fraction_high = high/(low+high),
num_cells = low+high)) %>%
left_join(kmeans_dim_id %>%
dplyr::select(reduced_dim_id, cluster_id, cluster_median) %>%
spread(cluster_id, cluster_median) %>%
setNames(c("reduced_dim_id", "kmns_lo_clstr_med", "kmns_hi_clstr_med")))
head(som_nodes_stats)
som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
T ~ "Neutral" ))
som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
T ~ "Neutral" )) %>%
table(som_clst_label)
som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
T ~ "Neutral" )) %>%
table(.$som_clst_label)
playing <- som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
T ~ "Neutral" ))
table(playing$som_clst_label)
table(playing$fraction_high)
playing <- som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
som_median > kmns_lo_clstr_med && fraction_high < 0.25 ~ "Low",
som_median < kmns_hi_clstr_med && fraction_high > 0.75 ~ "High",
T ~ "Neutral" ))
table(playing$som_clst_label)
plot_df %>%
ggplot(aes(mst_x, mst_y, color = cluster_id)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
theme(legend.position = "none")
plot_df %>%
ggplot(aes(mst_x, mst_y, color = cluster_id)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
theme(legend.position = "none")
head(plot_df)
dev.off()
head(playing)
data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2]))
playing <- som_nodes_stats %>%
mutate(som_clst_label = case_when(som_median <= kmns_lo_clstr_med ~ "Negative",
som_median >= kmns_hi_clstr_med ~ "Positive",
som_median > kmns_lo_clstr_med && fraction_high < 0.25 ~ "Low",
som_median < kmns_hi_clstr_med && fraction_high > 0.75 ~ "High",
T ~ "Neutral" ),
som_clst_label = factor(som_clst_label, levels = c("Negative", "Low", "Neutral", "High", "Positive")))
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
theme(legend.position = "none")
head(playing)
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
scale_color_gradientn(values = c("darkblue", "lightblue", "grey", "lightred", "darkred"))
?scale_color_manual
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
scale_color_manual(values = c("darkblue", "lightblue", "grey", "lightred", "darkred"))
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
scale_color_manual(values = c("darkblue", "lightblue", "grey", "red", "darkred"))
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label, size = num_cells)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
scale_color_manual(values = c("darkblue", "lightblue", "grey", "red", "darkred")) +
theme(legend.position = "none")
playing %>%
left_join(data.frame(som_node = c(1:nrow(mst$MST$l)),
mst_x = mst$MST$l[,1],
mst_y = mst$MST$l[,2])) %>%
ggplot(aes(mst_x, mst_y, color = som_clst_label, size = num_cells, alpha = 0.25)) +
geom_point() +
facet_wrap(~reduced_dim_id) +
theme_void() +
scale_color_manual(values = c("darkblue", "lightblue", "grey", "red", "darkred")) +
theme(legend.position = "none")
ggsave("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/som-plot.pdf",
width = 16,
height = 9)
dim(gsea_df)
gsea_df %>%
write_csv("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/glm-pcs-gsea-results.csv")
save.image("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled.RData")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled-ct-35.RData")
test_glmpca_poi_2 <- glmpca(filtered_counts,
2,
fam = "poi")
load("/Volumes/group05/CCBB/CS024892_Kelly_Beshiri/Untitled-ct-35.RData")
getwd
getwd()
source("single-cell/scrna2019/util/functions_genefilter.R")
source("single-cell/scrna2019/util/functions.R")
